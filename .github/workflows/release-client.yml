# GitHub Actions: å®¢æˆ·ç«¯å‘å¸ƒå·¥ä½œæµ
# å½“æ¨é€ v* æ ¼å¼çš„ Tag æ—¶ï¼Œè‡ªåŠ¨æ„å»º macOS/Windows/Linux ç‰ˆæœ¬å¹¶å‘å¸ƒåˆ° GitHub Releases

name: Release Client

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v1.2.3-beta ç­‰æ ¼å¼

# æˆäºˆ GITHUB_TOKEN å†™å…¥æƒé™
permissions:
  contents: write

env:
  NODE_VERSION: '20'

jobs:
  # åˆ›å»º Release
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Screen Sharing v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ‰ Screen Sharing v${{ steps.get_version.outputs.VERSION }}
            
            ### ä¸‹è½½
            - **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶
            - **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åº
            - **Linux**: ä¸‹è½½ `.AppImage` æˆ– `.deb` æ–‡ä»¶
            
            ### æ›´æ–°å†…å®¹
            è¯·æŸ¥çœ‹ [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # macOS æ„å»º
  build-macos:
    needs: create-release
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            shared/package-lock.json
            client/package-lock.json

      - name: Install dependencies (shared)
        working-directory: shared
        run: npm ci

      - name: Build shared
        working-directory: shared
        run: npm run build

      - name: Install dependencies (client)
        working-directory: client
        run: npm ci

      - name: Build Electron app
        working-directory: client
        run: npm run build:prod
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false  # è·³è¿‡ä»£ç ç­¾åï¼ˆå¦‚éœ€ç­¾åè¯·é…ç½®è¯ä¹¦ï¼‰

      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            client/release/*.dmg
            client/release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Windows æ„å»º
  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            shared/package-lock.json
            client/package-lock.json

      - name: Install dependencies (shared)
        working-directory: shared
        run: npm ci

      - name: Build shared
        working-directory: shared
        run: npm run build

      - name: Install dependencies (client)
        working-directory: client
        run: npm ci

      - name: Build Electron app
        working-directory: client
        run: npm run build:prod
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            client/release/*.exe
            client/release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Linux æ„å»º
  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            shared/package-lock.json
            client/package-lock.json

      - name: Install dependencies (shared)
        working-directory: shared
        run: npm ci

      - name: Build shared
        working-directory: shared
        run: npm run build

      - name: Install dependencies (client)
        working-directory: client
        run: npm ci

      - name: Build Electron app
        working-directory: client
        run: npm run build:prod
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            client/release/*.AppImage
            client/release/*.deb
            client/release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
