# 本地开发快速指南

## 🚀 快速启动

### 1. 启动本地服务器

```bash
cd server
npm run dev
```

服务器启动在 `http://localhost:3000`

### 2. 启动客户端

```bash
cd client
npm run dev
```

客户端会自动打开 `http://localhost:5173`

### 3. 配置连接（首次）

客户端默认已配置连接 `http://localhost:3000`，无需额外配置。

如果需要切换服务器，有两种方式：

#### 方式 A：通过 UI 设置
1. 打开客户端
2. 点击"设置"
3. 修改"服务器地址"
4. 保存

#### 方式 B：通过浏览器控制台（快捷方式）
按 F12 打开控制台，输入：

```javascript
// 切换到本地服务器
switchServer('LOCAL')

// 切换到 Render 生产环境
switchServer('RENDER')

// 查看当前配置
showCurrentServer()
```

然后刷新页面即可。

---

## 🔧 开发工作流

### 场景 1：修复 Bug（同一台电脑测试）

**步骤：**

1. **启动服务器**
   ```bash
   cd server && npm run dev
   ```

2. **启动客户端**
   ```bash
   cd client && npm run dev
   ```

3. **打开两个浏览器窗口测试**
   - 窗口 1：创建房间，开始共享
   - 窗口 2：加入房间，查看共享

4. **查看日志**
   - 服务器日志：在 `server` 终端查看
   - 客户端日志：F12 → Console

5. **修改代码**
   - 服务器代码修改后会自动重启
   - 客户端代码修改后会自动热更新

6. **测试验证**
   - 重复步骤 3，验证 Bug 是否修复

---

### 场景 2：测试跨网络 P2P 连接

**需求：** 测试真实的 NAT 穿透能力

**方案 A：使用 ngrok（推荐）**

1. **启动本地服务器**
   ```bash
   cd server && npm run dev
   ```

2. **启动 ngrok**
   ```bash
   ngrok http 3000
   ```

   复制输出的 HTTPS URL，例如：
   ```
   https://abc123-xyz.ngrok.io
   ```

3. **配置客户端**

   在浏览器控制台（F12）输入：
   ```javascript
   switchServer('NGROK')
   ```

   或手动在设置中填入 ngrok URL。

4. **测试**
   - 在本地电脑：创建房间
   - 在另一台电脑（不同网络）：访问客户端，加入房间
   - 验证 P2P 连接是否成功

**方案 B：使用 Render**

1. **配置连接到 Render**
   ```javascript
   switchServer('RENDER')
   ```

2. **测试**
   - 两台电脑都连接到 Render 服务器
   - 验证功能

---

### 场景 3：准备发布到生产环境

**流程：**

1. **本地测试通过**
   ```bash
   # 确保所有测试通过
   cd server && npm test
   cd client && npm run lint
   ```

2. **提交代码**
   ```bash
   git add .
   git commit -m "fix: 修复 P2P 连接问题"
   git push origin master
   ```

3. **Render 自动部署**
   - Render 检测到代码推送后会自动构建和部署
   - 可以在 Render Dashboard 查看部署日志

4. **验证生产环境**
   - 客户端切换到 Render URL
   - 进行完整功能测试

---

## 📝 调试技巧

### 1. 查看 WebRTC 连接详情

在浏览器访问：
```
chrome://webrtc-internals/
```

可以看到：
- ICE 候选类型（host/srflx/relay）
- 连接状态
- 带宽统计
- 错误信息

### 2. 查看服务器日志

服务器日志已经配置了详细的输出，你会看到：

```
[INFO] Socket连接成功
[INFO] 用户加入房间: { roomId: 'ABC123', userId: 'user_xxx' }
[INFO] 收到 Offer: { from: 'user_1', to: 'user_2' }
[INFO] 发送 Answer: { from: 'user_2', to: 'user_1' }
[INFO] ICE 候选交换: { type: 'srflx' }
```

### 3. 查看客户端日志

客户端 Socket 服务已配置详细日志，在 Console 中：

```javascript
[Socket] 事件: ROOM_JOINED
[Socket] 发送: SEND_OFFER { to: 'user_2' }
[Socket] 事件: WEBRTC_ANSWER { fromUserId: 'user_2' }
[WebRTC] 连接状态: connected
```

### 4. 验证 P2P 连接类型

在浏览器 Console 输入以下代码（需要在建立连接后）：

```javascript
// 假设你可以访问 RTCPeerConnection 实例
// 这段代码需要你在实际代码中暴露 peerConnection
const pc = /* 获取你的 peerConnection 实例 */;

pc.getStats().then(stats => {
  stats.forEach(report => {
    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
      console.log('✅ 活跃连接对:', report);
    }
    if (report.type === 'local-candidate') {
      console.log('📤 本地候选:', report.candidateType, report.address);
    }
    if (report.type === 'remote-candidate') {
      console.log('📥 远程候选:', report.candidateType, report.address);
    }
  });
});
```

**候选类型解释：**
- `host`: 本地网络/局域网直连
- `srflx`: NAT 穿透成功的 P2P 连接 ⭐
- `relay`: TURN 中继（本项目不支持）

---

## 🐛 常见问题

### Q1: 客户端无法连接到本地服务器

**检查：**
```bash
# 1. 确认服务器是否启动
curl http://localhost:3000/health

# 2. 查看服务器日志
# 在 server 终端查看是否有错误

# 3. 查看客户端配置
# 打开浏览器 Console，输入：
showCurrentServer()
```

### Q2: WebSocket 连接失败

**解决方案：**
1. 确认服务器正在运行
2. 检查防火墙是否阻止了 3000 端口
3. 查看浏览器 Console 的错误信息

### Q3: 同一台电脑测试，P2P 连接失败

**说明：** 这是正常的，同一台电脑上的两个客户端会使用本地回环（loopback）连接，不是真正的网络连接。

**建议：** 使用 ngrok 进行跨网络测试。

### Q4: ngrok URL 每次都变化

**解决方案：**
- 使用免费的 ngrok 会话时，URL 会在每次重启时变化
- 可以升级到付费版获得固定域名
- 或者使用 Render 等云平台提供稳定的 URL

---

## 📊 性能监控

### 查看服务器性能

```bash
# 查看 Node.js 进程
ps aux | grep node

# 查看内存使用
top -p $(pgrep -f "node.*server")
```

### 查看客户端性能

在浏览器 DevTools：
1. Performance 标签：录制性能分析
2. Network 标签：查看 WebSocket 流量
3. Memory 标签：检查内存泄漏

---

## 🎯 推荐的测试流程

### 第一阶段：基本功能测试（本地）
1. ✅ 启动服务器和客户端
2. ✅ 创建房间
3. ✅ 加入房间
4. ✅ 开始/停止屏幕共享
5. ✅ 多用户测试（两个浏览器窗口）

### 第二阶段：跨网络测试（ngrok）
1. ✅ 使用 ngrok 暴露本地服务器
2. ✅ 在不同网络的设备上测试
3. ✅ 验证 NAT 穿透
4. ✅ 检查连接类型（srflx）

### 第三阶段：生产环境验证（Render）
1. ✅ 部署到 Render
2. ✅ 在多个设备上测试
3. ✅ 性能和稳定性测试
4. ✅ 边界情况测试

---

## 🔗 相关文档

- [本地测试 P2P 连接指南](docs/本地测试P2P连接指南.md) - 详细测试场景
- [部署运维文档](docs/部署运维文档.md) - 生产环境部署
- [API 文档](docs/API文档.md) - WebSocket 事件定义
- [WebRTC 多人共享架构说明](docs/WebRTC多人共享架构说明.md) - P2P 连接原理

---

## ⚡ 快捷命令汇总

```bash
# 启动本地服务器
cd server && npm run dev

# 启动客户端
cd client && npm run dev

# 启动 ngrok
ngrok http 3000

# 查看服务器健康状态
curl http://localhost:3000/health

# 运行测试
cd server && npm test

# 代码检查
cd client && npm run lint
```

---

**祝开发顺利！** 🎉

如有问题，可以：
1. 查看服务器日志
2. 查看浏览器 Console
3. 访问 `chrome://webrtc-internals/` 调试 WebRTC
