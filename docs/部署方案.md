# Server 部署方案

## 问题分析

当前 server 使用 **Socket.io** 进行实时 WebRTC 信令通信，具有以下特点：
- 需要 WebSocket 长连接支持
- 需要有状态的服务器（房间、用户状态管理）
- 需要持久化进程

**Vercel Serverless Functions 的限制：**
- ❌ 不支持 WebSocket 长连接
- ❌ 无状态，每次请求是独立的
- ❌ 最大执行时间 10-60 秒
- ❌ 无法维持房间状态

## ⚠️ 重要提示：支付方式要求

**截至 2026 年 1 月，主流部署平台均需要绑定支付方式（信用卡/借记卡）才能使用，即使是免费套餐：**

- ✅ **Railway**：需要绑定支付方式，提供 $5/月 免费额度
- ✅ **Render**：需要绑定支付方式，提供免费套餐
- ✅ **Fly.io**：需要绑定支付方式，提供免费套餐

**无需绑卡的替代方案：**
- 自建服务器（VPS）：如阿里云、腾讯云学生机
- Docker 本地部署
- 使用 ngrok/frp 等内网穿透工具临时测试

## 推荐部署方案

### 方案一：Railway（推荐 ⭐⭐⭐⭐⭐）

**优点：**
- 原生支持 WebSocket
- 支持持久化进程
- 自动 SSL 证书
- 免费额度：每月 $5 免费额度
- 部署简单，一键部署

**部署步骤：**
```bash
# 1. 安装 Railway CLI
npm i -g @railway/cli

# 2. 登录
railway login

# 3. 初始化项目
cd server
railway init

# 4. 部署
railway up
```

### 方案二：Render（推荐 ⭐⭐⭐⭐）

**优点：**
- 免费套餐支持 WebSocket
- 自动 SSL
- GitHub 自动部署

**限制：**
- ⚠️ **需要绑定信用卡**才能使用

**部署步骤：**
1. 在 render.com 创建账号并绑定支付方式
2. 新建 Web Service
3. 连接 GitHub 仓库
4. 配置：
   - Root Directory: `server`
   - Build Command: `npm install && npm run build`
   - Start Command: `npm start`

### 方案三：Fly.io（推荐 ⭐⭐⭐⭐）

**优点：**
- 全球边缘部署
- 支持 WebSocket
- 免费套餐（3个VM，256MB内存，160GB流量/月）

**限制：**
- ⚠️ **需要绑定支付方式**才能使用
- 香港区域已下线，需使用新加坡(sin)或东京(nrt)

**部署步骤：**
```bash
# 1. 安装 flyctl (Windows PowerShell)
pwsh -Command "iwr https://fly.io/install.ps1 -useb | iex"

# 2. 登录并绑定支付方式
C:\Users\admin\.fly\bin\flyctl.exe auth login

# 3. 初始化并部署
cd server
C:\Users\admin\.fly\bin\flyctl.exe launch
C:\Users\admin\.fly\bin\flyctl.exe deploy
```

### 方案四：使用 Vercel + 第三方 WebSocket 服务（混合方案）

如果一定要用 Vercel，可以：
- Vercel 部署静态 API
- 使用 **Ably** 或 **Pusher** 作为实时通信层
- 需要重构代码

**不推荐原因：** 需要大量代码重构，增加复杂性

## 选择建议

| 方案 | 难度 | 成本 | 需要绑卡 | 推荐度 |
|------|------|------|----------|--------|
| Railway | ⭐ | $5/月免费额度 | ✅ 是 | ⭐⭐⭐⭐⭐ |
| Render | ⭐ | 免费套餐 | ✅ 是 | ⭐⭐⭐⭐ |
| Fly.io | ⭐⭐ | 免费套餐 | ✅ 是 | ⭐⭐⭐⭐ |
| Vercel + Ably | ⭐⭐⭐⭐⭐ | 付费 | ✅ 是 | ⭐ |

## 我的推荐

### 如果可以绑定支付方式
**使用 Railway 部署**，原因：
1. 支持 WebSocket，无需改代码
2. 部署最简单
3. $5/月免费额度足够开发测试
4. 支持自定义域名

### 如果无法绑定支付方式
**使用以下替代方案：**

#### 1. Docker 本地部署 + 内网穿透
```bash
# 构建并运行
cd server
npm run docker:build
npm run docker:run

# 使用 ngrok 暴露服务
ngrok http 3000
```

#### 2. 自建 VPS 服务器
- 阿里云学生机：9.5元/月
- 腾讯云学生机：10元/月
- 使用项目中的 Dockerfile 部署

#### 3. GitHub Codespaces
- 每月 60 小时免费
- 可临时测试使用
- 支持端口转发
