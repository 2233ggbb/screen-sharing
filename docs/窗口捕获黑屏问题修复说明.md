# 窗口捕获黑屏问题修复说明

## 问题描述

在 Windows 系统上使用屏幕共享功能时:
- ✅ 分享整个屏幕正常工作
- ❌ 分享单个窗口时,接收方看到黑屏

## 错误日志

```
ERROR:third_party\webrtc\modules\desktop_capture\win\wgc_capturer_win.cc:343] Source is not capturable.
```

## 问题根源

Windows Graphics Capture (WGC) API 是 Windows 10/11 用于屏幕捕获的现代 API。该错误表明某些窗口被标记为"不可捕获"。

**核心原因:**
1. Chromium/Electron 默认启用了内容保护机制
2. 某些 Chromium 特性会阻止 WGC API 捕获窗口内容
3. 默认的窗口配置可能不允许被屏幕捕获 API 访问

## 解决方案

### 1. 禁用 Chromium 内容保护特性

在应用启动时添加命令行参数:

```typescript
// 禁用阻止窗口捕获的特性
app.commandLine.appendSwitch('disable-features', 'HardwareMediaKeyHandling,MediaSessionService');
app.commandLine.appendSwitch('enable-features', 'WebRTCPipeWireCapturer');
app.commandLine.appendSwitch('disable-gpu-sandbox');
```

**说明:**
- `disable-features`: 禁用可能干扰屏幕捕获的媒体会话服务
- `enable-features`: 启用 WebRTC 的 PipeWire 捕获器(提高兼容性)
- `disable-gpu-sandbox`: 禁用 GPU 沙箱,允许更自由的窗口捕获

### 2. 设置窗口内容保护为 false

在窗口创建后立即设置:

```typescript
mainWindow.setContentProtection(false);
```

这明确告诉 Electron 允许此窗口的内容被外部 API 捕获。

### 3. 确保窗口在任务栏可见

```typescript
skipTaskbar: false
```

这有助于 WGC API 正确识别和枚举窗口。

## 修复的文件

### [`client/src/main/index.ts`](../client/src/main/index.ts)

**修改内容:**

1. 添加 Chromium 命令行参数(第 9-13 行)
2. 设置 `skipTaskbar: false`(第 37 行)
3. 调用 `mainWindow.setContentProtection(false)`(第 47 行)

## 技术细节

### Windows Graphics Capture (WGC)

WGC 是 Windows 10 1803+ 引入的现代屏幕捕获 API,相比旧的 GDI 和 DXGI 有以下优势:
- 更好的性能
- 支持硬件加速
- 更低的 CPU 使用率

但 WGC 有一个限制:**必须显式允许窗口被捕获**。

### Chromium 内容保护

Chromium 浏览器引擎默认启用多种内容保护机制,包括:
- DRM 内容保护
- 媒体会话隔离
- GPU 进程沙箱

这些机制可能会阻止 WGC API 访问窗口内容。

## 测试验证

### 测试步骤

1. **重新启动应用**
   ```bash
   cd client
   npm run dev
   ```

2. **创建房间并加入**
   - 在一个浏览器/客户端创建房间
   - 在另一个客户端加入同一房间

3. **测试屏幕共享**
   - 点击"开始共享"
   - 选择单个应用窗口(不是整个屏幕)
   - 确认接收方能正常看到窗口内容(不是黑屏)

4. **验证日志**
   - 检查控制台,确认没有 "Source is not capturable" 错误

### 预期结果

✅ 可以成功分享整个屏幕
✅ 可以成功分享单个窗口
✅ 接收方看到的是正常的窗口内容,不是黑屏
✅ 没有 WGC 相关错误日志

## 相关资源

- [Electron BrowserWindow 文档](https://www.electronjs.org/docs/latest/api/browser-window)
- [Electron setContentProtection API](https://www.electronjs.org/docs/latest/api/browser-window#winsetcontentprotectionenable)
- [Chromium Command Line Switches](https://peter.sh/experiments/chromium-command-line-switches/)
- [Windows Graphics Capture API](https://docs.microsoft.com/en-us/windows/uwp/audio-video-camera/screen-capture)

## 注意事项

1. **安全性**: 禁用内容保护可能会让窗口内容更容易被捕获,但这正是屏幕共享应用所需要的
2. **兼容性**: 这些修改仅影响 Electron 客户端,Web 版本不受影响
3. **性能**: 禁用 GPU 沙箱可能略微影响性能,但对屏幕共享应用来说利大于弊

## 更新日志

- **2026-01-25**: 修复 Windows WGC 窗口捕获黑屏问题
  - 添加 Chromium 命令行参数
  - 设置窗口内容保护为 false
  - 确保窗口在任务栏可见
