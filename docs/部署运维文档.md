# 多人屏幕共享系统 - 部署运维文档

## 文档信息

| 项目名称 | 多人屏幕共享系统 |
|---------|-----------------|
| 文档版本 | v1.0 |
| 创建日期 | 2026-01-04 |
| 文档类型 | 部署运维指南 |

---

## 1. 环境要求

### 1.1 服务端环境

#### 1.1.1 硬件要求

| 配置项 | 最低配置 | 推荐配置 | 说明 |
|-------|---------|---------|------|
| **CPU** | 2核心 | 4核心+ | 主频2.0GHz以上 |
| **内存** | 2GB | 4GB+ | 建议8GB用于高并发 |
| **存储** | 20GB | 50GB SSD | 用于日志和临时文件 |
| **网络带宽** | 10Mbps | 50Mbps+ | 上下行对等 |

#### 1.1.2 软件要求

| 软件 | 版本要求 | 说明 |
|------|---------|------|
| **操作系统** | Ubuntu 20.04+ / CentOS 8+ | 推荐Ubuntu 22.04 LTS |
| **Node.js** | 20.x LTS | 使用nvm管理版本 |
| **npm** | 10.x+ | 或使用yarn/pnpm |
| **Git** | 2.x+ | 用于代码拉取 |
| **SSL证书** | - | 生产环境必须配置HTTPS |

#### 1.1.3 网络要求

- **公网IP**: 必须有公网IP地址
- **开放端口**:
  - `80`: HTTP（用于重定向到HTTPS）
  - `443`: HTTPS/WSS（主要服务端口）
  - `3478`: TURN服务器（UDP/TCP）
  - `49152-65535`: TURN服务器数据端口范围（可选）

---

### 1.2 客户端环境

#### 1.2.1 操作系统支持

| 操作系统 | 版本要求 | 架构 |
|---------|---------|------|
| **Windows** | Windows 10+ | x64 |
| **macOS** | 10.15+ (Catalina) | x64 / ARM64 (Apple Silicon) |
| **Linux** | Ubuntu 20.04+ / Fedora 36+ | x64 |

#### 1.2.2 硬件要求

| 配置项 | 最低配置 | 推荐配置 |
|-------|---------|---------|
| **CPU** | Intel i3 / AMD同级 | Intel i5 / AMD Ryzen 5 |
| **内存** | 4GB | 8GB+ |
| **显卡** | 集成显卡 | 独立显卡（更流畅） |
| **网络** | 5Mbps | 10Mbps+ |

---

## 2. 服务端部署

### 2.1 单机部署（适合小团队）

#### 2.1.1 准备工作

```bash
# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装Node.js（使用nvm）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
node --version  # 验证版本

# 3. 安装Git
sudo apt install git -y

# 4. 创建部署目录
sudo mkdir -p /opt/screen-sharing
sudo chown $USER:$USER /opt/screen-sharing
cd /opt/screen-sharing
```

#### 2.1.2 拉取代码并安装依赖

```bash
# 克隆代码仓库
git clone https://github.com/your-org/screen-sharing.git .

# 安装服务端依赖
cd server
npm install --production

# 安装共享模块依赖
cd ../shared
npm install
npm run build

# 回到项目根目录
cd ..
```

#### 2.1.3 配置文件

创建服务端配置文件 `server/config/production.json`:

```json
{
  "server": {
    "port": 3000,
    "host": "0.0.0.0",
    "env": "production"
  },
  "websocket": {
    "cors": {
      "origin": "*",
      "credentials": true
    },
    "pingTimeout": 10000,
    "pingInterval": 5000,
    "transports": ["websocket", "polling"]
  },
  "room": {
    "maxRooms": 100,
    "maxMembersPerRoom": 10,
    "maxStreamsPerRoom": 10,
    "roomIdLength": 6,
    "autoCleanupInterval": 300000
  },
  "security": {
    "maxConnectionsPerIP": 10,
    "rateLimitWindow": 60000,
    "rateLimitMax": 100
  },
  "logging": {
    "level": "info",
    "directory": "./logs",
    "maxFiles": 30,
    "maxSize": "100m"
  },
  "ssl": {
    "enabled": true,
    "certPath": "/etc/letsencrypt/live/your-domain.com/fullchain.pem",
    "keyPath": "/etc/letsencrypt/live/your-domain.com/privkey.pem"
  }
}
```

#### 2.1.4 构建并启动服务

```bash
cd server

# 构建TypeScript
npm run build

# 使用PM2管理进程
npm install -g pm2

# 启动服务
pm2 start dist/index.js --name screen-sharing-server

# 查看日志
pm2 logs screen-sharing-server

# 设置开机自启
pm2 startup
pm2 save
```

---

### 2.2 使用Docker部署

#### 2.2.1 创建Dockerfile

服务端 `server/Dockerfile`:

```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

# 复制package文件
COPY package*.json ./
COPY ../shared/package*.json ../shared/

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建TypeScript
RUN npm run build

# 生产镜像
FROM node:20-alpine

WORKDIR /app

# 复制构建产物和依赖
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./

# 暴露端口
EXPOSE 3000

# 启动应用
CMD ["node", "dist/index.js"]
```

#### 2.2.2 Docker Compose配置

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  # 信令服务器
  signaling-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: screen-sharing-server
    restart: always
    ports:
      - "3000:3000"
      - "443:443"
    volumes:
      - ./logs:/app/logs
      - ./server/config:/app/config
      - /etc/letsencrypt:/etc/letsencrypt:ro
    environment:
      - NODE_ENV=production
      - PORT=3000
    networks:
      - screen-sharing-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # TURN服务器（可选）
  turn-server:
    image: coturn/coturn:latest
    container_name: coturn-server
    restart: always
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49152-65535:49152-65535/udp"
    volumes:
      - ./turnserver.conf:/etc/coturn/turnserver.conf:ro
    networks:
      - screen-sharing-network

networks:
  screen-sharing-network:
    driver: bridge
```

#### 2.2.3 启动Docker服务

```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f signaling-server

# 查看运行状态
docker-compose ps

# 停止服务
docker-compose down

# 重启服务
docker-compose restart signaling-server
```

---

### 2.3 TURN服务器配置

#### 2.3.1 安装Coturn

```bash
# Ubuntu/Debian
sudo apt install coturn -y

# 启用Coturn服务
sudo systemctl enable coturn
```

#### 2.3.2 配置文件

创建 `turnserver.conf`:

```conf
# TURN服务器监听端口
listening-port=3478
tls-listening-port=5349

# 外部IP（公网IP）
external-ip=YOUR_PUBLIC_IP

# 认证方式
use-auth-secret
static-auth-secret=YOUR_SECRET_KEY

# 域名
realm=your-domain.com

# 日志
log-file=/var/log/turnserver.log
verbose

# 性能优化
max-bps=1000000
user-quota=0
total-quota=0

# 监听的网络接口
listening-ip=0.0.0.0
relay-ip=YOUR_PUBLIC_IP

# 数据端口范围
min-port=49152
max-port=65535

# 禁用TCP中继（仅使用UDP）
no-tcp-relay

# 启用指纹
fingerprint
```

#### 2.3.3 启动TURN服务

```bash
# 启动服务
sudo systemctl start coturn

# 查看状态
sudo systemctl status coturn

# 查看日志
sudo tail -f /var/log/turnserver.log
```

---

### 2.4 SSL/TLS证书配置

#### 2.4.1 使用Let's Encrypt免费证书

```bash
# 安装Certbot
sudo apt install certbot -y

# 获取证书（HTTP验证）
sudo certbot certonly --standalone -d your-domain.com

# 证书路径
# 证书: /etc/letsencrypt/live/your-domain.com/fullchain.pem
# 私钥: /etc/letsencrypt/live/your-domain.com/privkey.pem

# 自动续期测试
sudo certbot renew --dry-run

# 设置定时任务自动续期
echo "0 3 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

#### 2.4.2 配置Nginx作为反向代理

创建 `nginx.conf`:

```nginx
events {
    worker_connections 1024;
}

http {
    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name your-domain.com;
        
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS服务
    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        # SSL证书配置
        ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

        # SSL安全配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # 反向代理到Node.js服务
        location / {
            proxy_pass http://localhost:3000;
            proxy_http_version 1.1;
            
            # WebSocket支持
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # 代理头
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 健康检查
        location /health {
            proxy_pass http://localhost:3000/health;
        }
    }
}
```

---

## 3. 客户端部署

### 3.1 开发环境构建

```bash
cd client

# 安装依赖
npm install

# 开发模式运行
npm run dev

# 构建应用
npm run build
```

### 3.2 打包发布

#### 3.2.1 配置electron-builder

创建 `client/electron-builder.json`:

```json
{
  "appId": "com.yourcompany.screen-sharing",
  "productName": "ScreenSharing",
  "directories": {
    "output": "release"
  },
  "files": [
    "dist/**/*",
    "node_modules/**/*",
    "package.json"
  ],
  "mac": {
    "category": "public.app-category.productivity",
    "target": ["dmg", "zip"],
    "icon": "build/icons/icon.icns",
    "entitlements": "build/entitlements.mac.plist",
    "hardenedRuntime": true,
    "gatekeeperAssess": false
  },
  "win": {
    "target": ["nsis", "zip"],
    "icon": "build/icons/icon.ico"
  },
  "linux": {
    "target": ["AppImage", "deb"],
    "icon": "build/icons",
    "category": "Network"
  },
  "nsis": {
    "oneClick": false,
    "allowToChangeInstallationDirectory": true,
    "createDesktopShortcut": true,
    "createStartMenuShortcut": true
  }
}
```

#### 3.2.2 macOS权限配置

创建 `client/build/entitlements.mac.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
  <true/>
  <key>com.apple.security.device.camera</key>
  <true/>
  <key>com.apple.security.device.audio-input</key>
  <true/>
  <key>com.apple.security.cs.disable-library-validation</key>
  <true/>
</dict>
</plist>
```

#### 3.2.3 打包命令

```bash
cd client

# 打包当前平台
npm run build:prod

# 打包所有平台（需要在对应系统上执行）
npm run build:all

# 仅打包macOS
npm run build:mac

# 仅打包Windows
npm run build:win

# 仅打包Linux
npm run build:linux
```

---

## 4. 运维管理

### 4.1 进程管理（PM2）

#### 4.1.1 常用命令

```bash
# 启动应用
pm2 start dist/index.js --name screen-sharing-server

# 查看所有进程
pm2 list

# 查看详细信息
pm2 show screen-sharing-server

# 查看日志
pm2 logs screen-sharing-server

# 实时日志
pm2 logs screen-sharing-server --lines 100

# 停止应用
pm2 stop screen-sharing-server

# 重启应用
pm2 restart screen-sharing-server

# 删除应用
pm2 delete screen-sharing-server

# 零停机重启
pm2 reload screen-sharing-server

# 查看监控
pm2 monit
```

#### 4.1.2 PM2配置文件

创建 `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [{
    name: 'screen-sharing-server',
    script: 'dist/index.js',
    instances: 2,  // 使用集群模式，2个实例
    exec_mode: 'cluster',
    watch: false,
    max_memory_restart: '500M',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true,
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s'
  }]
};
```

使用配置文件启动：

```bash
pm2 start ecosystem.config.js
```

---

### 4.2 日志管理

#### 4.2.1 日志目录结构

```
logs/
├── access.log          # 访问日志
├── error.log           # 错误日志
├── combined.log        # 综合日志
└── debug.log           # 调试日志
```

#### 4.2.2 日志轮转配置

使用logrotate管理日志：

创建 `/etc/logrotate.d/screen-sharing`:

```conf
/opt/screen-sharing/server/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 $USER $USER
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

#### 4.2.3 查看日志

```bash
# 实时查看访问日志
tail -f logs/access.log

# 查看错误日志
tail -f logs/error.log

# 搜索特定内容
grep "error" logs/error.log

# 统计错误数量
grep -c "ERROR" logs/error.log

# 查看最近100行
tail -n 100 logs/combined.log
```

---

### 4.3 监控告警

#### 4.3.1 系统资源监控

```bash
# 查看CPU使用率
top

# 查看内存使用
free -h

# 查看磁盘使用
df -h

# 查看网络流量
iftop

# 查看进程资源
ps aux | grep node
```

#### 4.3.2 应用监控

使用PM2监控：

```bash
# 安装PM2 Plus（可选）
pm2 install pm2-server-monit

# 查看实时监控
pm2 monit

# 查看资源使用
pm2 show screen-sharing-server
```

#### 4.3.3 健康检查脚本

创建 `health-check.sh`:

```bash
#!/bin/bash

# 健康检查URL
HEALTH_URL="http://localhost:3000/health"

# 检查服务状态
response=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)

if [ $response -eq 200 ]; then
    echo "$(date): Service is healthy"
    exit 0
else
    echo "$(date): Service is unhealthy (HTTP $response)"
    # 尝试重启服务
    pm2 restart screen-sharing-server
    exit 1
fi
```

设置定时任务：

```bash
# 每5分钟检查一次
*/5 * * * * /opt/screen-sharing/health-check.sh >> /var/log/health-check.log 2>&1
```

---

### 4.4 备份与恢复

#### 4.4.1 配置文件备份

```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/backup/screen-sharing"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz \
    /opt/screen-sharing/server/config/ \
    /etc/nginx/nginx.conf \
    /etc/turnserver.conf

# 保留最近7天的备份
find $BACKUP_DIR -name "config_*.tar.gz" -mtime +7 -delete

echo "Backup completed: config_$DATE.tar.gz"
EOF

chmod +x backup.sh

# 设置每天凌晨2点执行备份
echo "0 2 * * * /opt/screen-sharing/backup.sh" | crontab -
```

#### 4.4.2 日志备份

```bash
# 压缩并归档旧日志
tar -czf logs_backup_$(date +%Y%m%d).tar.gz logs/*.log

# 移动到备份目录
mv logs_backup_*.tar.gz /backup/screen-sharing/logs/
```

---

### 4.5 更新升级

#### 4.5.1 零停机更新

```bash
#!/bin/bash

# 更新脚本
cd /opt/screen-sharing

# 1. 拉取最新代码
git pull origin main

# 2. 备份当前版本
cp -r server server_backup_$(date +%Y%m%d)

# 3. 安装依赖
cd server
npm install --production

# 4. 构建
npm run build

# 5. 重启服务（零停机）
pm2 reload screen-sharing-server

# 6. 验证
sleep 5
curl -s http://localhost:3000/health

# 7. 清理旧备份（保留最近3个）
cd /opt/screen-sharing
ls -t | grep server_backup_ | tail -n +4 | xargs rm -rf
```

#### 4.5.2 回滚版本

```bash
#!/bin/bash

# 回滚到上一个版本
BACKUP_DIR=$(ls -t /opt/screen-sharing | grep server_backup_ | head -n 1)

if [ -z "$BACKUP_DIR" ]; then
    echo "No backup found"
    exit 1
fi

# 停止服务
pm2 stop screen-sharing-server

# 恢复备份
rm -rf /opt/screen-sharing/server
cp -r /opt/screen-sharing/$BACKUP_DIR /opt/screen-sharing/server

# 启动服务
pm2 start screen-sharing-server

echo "Rollback completed from $BACKUP_DIR"
```

---

## 5. 性能优化

### 5.1 系统优化

#### 5.1.1 调整文件描述符限制

编辑 `/etc/security/limits.conf`:

```conf
*  soft  nofile  65535
*  hard  nofile  65535
```

#### 5.1.2 优化网络参数

编辑 `/etc/sysctl.conf`:

```conf
# 增加TCP连接队列
net.core.somaxconn = 1024

# 增加网络缓冲区
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

# TCP优化
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_tw_reuse = 1
```

应用配置：

```bash
sudo sysctl -p
```

---

### 5.2 应用优化

#### 5.2.1 Node.js内存优化

```bash
# 增加Node.js堆内存
pm2 start dist/index.js \
  --name screen-sharing-server \
  --node-args="--max-old-space-size=2048"
```

#### 5.2.2 启用Gzip压缩

在服务端代码中添加：

```typescript
import compression from 'compression';

app.use(compression({
  threshold: 1024,  // 超过1KB才压缩
  level: 6          // 压缩级别（0-9）
}));
```

---

## 6. 安全加固

### 6.1 防火墙配置

```bash
# 安装UFW
sudo apt install ufw

# 默认拒绝所有入站
sudo ufw default deny incoming

# 默认允许所有出站
sudo ufw default allow outgoing

# 允许SSH
sudo ufw allow 22/tcp

# 允许HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许TURN服务器
sudo ufw allow 3478/tcp
sudo ufw allow 3478/udp
sudo ufw allow 49152:65535/udp

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status
```

### 6.2 Fail2Ban配置

```bash
# 安装Fail2Ban
sudo apt install fail2ban

# 创建配置文件
sudo cat > /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = 22
EOF

# 启动服务
sudo systemctl start fail2ban
sudo systemctl enable fail2ban
```

---

## 7. 故障排查

### 7.1 常见问题

#### 7.1.1 服务无法启动

```bash
# 检查端口占用
sudo lsof -i :3000

# 检查进程
ps aux | grep node

# 查看日志
pm2 logs screen-sharing-server --err

# 检查配置文件
cat server/config/production.json
```

#### 7.1.2 WebSocket连接失败

```bash
# 测试WebSocket连接
wscat -c wss://your-domain.com

# 检查Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

#### 7.1.3 TURN服务器不工作

```bash
# 检查TURN服务状态
sudo systemctl status coturn

# 测试TURN服务器
turnutils-uclient -v YOUR_PUBLIC_IP

# 查看TURN日志
sudo tail -f /var/log/turnserver.log
```

---

### 7.2 调试工具

```bash
# 网络调试
netstat -tuln | grep 3000

# 抓包分析
sudo tcpdump -i any port 3000 -w capture.pcap

# 性能分析
node --prof dist/index.js
node --prof-process isolate-*.log > profile.txt
```

---

## 8. 应急预案

### 8.1 服务中断处理

```bash
# 1. 立即重启服务
pm2 restart screen-sharing-server

# 2. 如果重启失败，检查日志
pm2 logs screen-sharing-server --err

# 3. 回滚到上一个版本
./rollback.sh

# 4. 通知用户
# 发送系统通知或邮件
```

### 8.2 负载过高处理

```bash
# 1. 增加PM2实例数
pm2 scale screen-sharing-server +2

# 2. 限制新连接
# 在代码中添加连接数限制

# 3. 重启服务
pm2 reload screen-sharing-server
```

---

## 9. 监控指标

### 9.1 关键指标

| 指标 | 正常范围 | 告警阈值 | 处理措施 |
|------|---------|---------|---------|
| **CPU使用率** | < 50% | > 80% | 扩容或优化代码 |
| **内存使用率** | < 70% | > 85% | 增加内存或重启 |
| **磁盘使用率** | < 70% | > 85% | 清理日志 |
| **活跃连接数** | < 500 | > 800 | 限流或扩容 |
| **响应时间** | < 100ms | > 500ms | 性能优化 |
| **错误率** | < 1% | > 5% | 排查错误原因 |

---

## 10. 附录

### 10.1 常用命令速查

```bash
# 服务管理
pm2 start/stop/restart/reload <app>

# 日志查看
pm2 logs <app>
tail -f logs/*.log

# 进程监控
pm2 monit
htop

# 网络检查
netstat -tuln
ss -tuln

# 磁盘检查
df -h
du -sh *

# 系统信息
uname -a
cat /proc/cpuinfo
cat /proc/meminfo
```

### 10.2 配置文件模板

所有配置文件模板已在文档中提供，包括：
- `production.json` - 服务端配置
- `turnserver.conf` - TURN服务器配置
- `nginx.conf` - Nginx配置
- `ecosystem.config.js` - PM2配置
- `docker-compose.yml` - Docker配置

---

**文档结束**
