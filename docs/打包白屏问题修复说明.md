# Electron 打包后白屏问题修复说明

## 问题分析

打包后的 Electron 应用白屏通常是由以下原因导致的:

1. **React Router 配置问题**: `BrowserRouter` 依赖 HTML5 History API，在 Electron 通过 `file://` 协议加载时无法正常工作，会尝试请求 `file:///D:/` 这样的路径，导致 `ERR_FILE_NOT_FOUND` 错误
2. **资源路径问题**: Vite 打包后的资源使用了绝对路径 `/assets/`,在 Electron 通过 `file://` 协议加载时无法找到资源
3. **CSP 安全策略**: Content Security Policy 可能阻止本地资源加载
4. **缺少错误日志**: 打包后无法看到控制台错误,难以定位问题

## 根本原因（2026-01-10 修复）

错误表现为:
```
Request URL: file:///D:/
Referrer Policy: strict-origin-when-cross-origin
结果: (failed)net::ERR_FILE_NOT_FOUND
```

**根本原因**: 使用 `BrowserRouter` 而非 `HashRouter`。

`BrowserRouter` 使用 HTML5 History API 进行路由管理，需要服务器支持。当 Electron 应用使用 `file://` 协议加载本地 HTML 文件时，`BrowserRouter` 会尝试访问文件系统的根路径（如 `file:///D:/`），这会导致 `ERR_FILE_NOT_FOUND` 错误。

## 已实施的修复

### 0. React Router 修复 ([`client/src/renderer/App.tsx`](../client/src/renderer/App.tsx))

**核心修复**：将 `BrowserRouter` 替换为 `HashRouter`。

```typescript
// 修复前 ❌
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
// ...
<BrowserRouter>
  <Routes>
    <Route path="/" element={<Home />} />
    {/* ... */}
  </Routes>
</BrowserRouter>

// 修复后 ✅
import { HashRouter, Routes, Route, Navigate } from 'react-router-dom';
// ...
/**
 * 使用 HashRouter 而非 BrowserRouter
 * 因为 Electron 打包后使用 file:// 协议加载页面
 * BrowserRouter 依赖 HTML5 History API，在 file:// 协议下会导致路由失效
 * HashRouter 使用 URL hash 管理路由，完全兼容 file:// 协议
 */
<HashRouter>
  <Routes>
    <Route path="/" element={<Home />} />
    {/* ... */}
  </Routes>
</HashRouter>
```

**为什么 HashRouter 能解决问题？**

| 特性 | BrowserRouter | HashRouter |
|------|---------------|------------|
| URL 格式 | `/room/123` | `/#/room/123` |
| 依赖 | HTML5 History API | URL hash (#) |
| 服务器支持 | 需要 | 不需要 |
| file:// 协议 | ❌ 不支持 | ✅ 完全支持 |

### 1. Vite 配置修改 ([`client/vite.config.ts`](../client/vite.config.ts))

```typescript
export default defineConfig({
  // 设置 base 为相对路径,确保打包后资源正确加载
  base: './',
  // ...
  build: {
    outDir: 'dist/renderer',
    emptyOutDir: true,
    // 确保资源路径正确
    assetsDir: 'assets',
    // 生产环境不生成 sourcemap 减小包体积
    sourcemap: false,
  },
});
```

**关键修改:**
- `base: './'` - 使用相对路径,确保在 `file://` 协议下资源路径正确
- `assetsDir: 'assets'` - 明确指定资源目录

### 2. 主进程错误监听 ([`client/src/main/index.ts`](../client/src/main/index.ts))

```typescript
// 监听渲染进程的控制台消息,便于调试打包后的问题
mainWindow.webContents.on('console-message', (_event, level, message, line, sourceId) => {
  console.log(`[Renderer Console ${level}]:`, message, `at ${sourceId}:${line}`);
});

// 监听加载失败事件
mainWindow.webContents.on('did-fail-load', (_event, errorCode, errorDescription) => {
  console.error('Failed to load:', errorCode, errorDescription);
});

// 生产环境加载本地文件时添加错误处理
mainWindow.loadFile(indexPath).catch(err => {
  console.error('Failed to load index.html:', err);
});
```

**改进点:**
- 添加控制台消息监听,便于查看渲染进程的日志
- 添加加载失败事件监听
- 添加文件加载的错误处理

## 重新构建步骤

### 1. 清理旧的构建产物

```bash
cd client
rm -rf dist
rm -rf release
```

PowerShell 命令:
```powershell
cd client
Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
Remove-Item -Recurse -Force release -ErrorAction SilentlyContinue
```

### 2. 重新构建应用

```bash
# 构建渲染进程和主进程
npm run build

# 打包成可执行文件
npm run build:prod
```

### 3. 测试打包后的应用

Windows:
```
client\release\win-unpacked\ScreenSharing.exe
```

打开应用后,检查:
- [ ] 应用能否正常启动
- [ ] 界面是否正常显示(不再白屏)
- [ ] 功能是否正常工作

### 4. 查看日志(如果仍有问题)

打包后的应用日志会输出到:
- Windows: 在命令行中启动 exe 文件可以看到日志
- 或者使用开发者工具(如果启用了): Ctrl+Shift+I

## 验证修复

修复后的行为:

1. **开发环境**: 保持不变,使用 `http://localhost:5173`
2. **生产环境**: 
   - HTML 中的资源路径从 `/assets/` 变为 `./assets/`
   - 应用能正确加载 JS 和 CSS 文件
   - 界面正常显示

## 如果问题仍然存在

### 调试步骤:

1. **启用开发者工具**
   临时在 [`client/src/main/index.ts`](../client/src/main/index.ts) 中添加:
   ```typescript
   if (!isDev) {
     mainWindow.webContents.openDevTools();
   }
   ```

2. **检查资源路径**
   在开发者工具的 Console 或 Network 标签中查看:
   - 资源请求的完整路径
   - 是否返回 404 错误
   - 是否有 CSP 错误

3. **检查构建产物**
   验证 `client/dist/renderer/index.html` 中的资源路径格式

### 常见问题:

**Q: 资源路径仍然是绝对路径**
A: 确保 `base: './'` 配置生效,重新运行 `npm run build`

**Q: 提示安全策略错误**
A: 检查是否有自定义的 CSP 配置,确保允许加载本地资源

**Q: JS 文件加载失败**
A: 检查 `dist/renderer/assets/` 目录是否存在打包后的 JS 文件

## 相关文件

- [`client/vite.config.ts`](../client/vite.config.ts) - Vite 配置
- [`client/src/main/index.ts`](../client/src/main/index.ts) - Electron 主进程
- [`client/package.json`](../client/package.json) - 构建脚本和 electron-builder 配置
- [`client/index.html`](../client/index.html) - 开发环境 HTML 模板

## 额外优化建议

1. **添加加载动画**: 在白屏期间显示加载提示
2. **错误边界**: 添加 React 错误边界捕获渲染错误
3. **性能监控**: 添加启动时间监控
